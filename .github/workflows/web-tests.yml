name: Web Interface Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/vpc_flow_investigator/web.py'
      - 'src/vpc_flow_investigator/templates/**'
      - 'src/vpc_flow_investigator/static/**'
      - 'tests/test_web.py'
      - '.github/workflows/web-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/vpc_flow_investigator/web.py'
      - 'src/vpc_flow_investigator/templates/**'
      - 'src/vpc_flow_investigator/static/**'
      - 'tests/test_web.py'
      - '.github/workflows/web-tests.yml'

jobs:
  api-tests:
    name: API Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.12', '3.13']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-web-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/pyproject.toml') }}

    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: |
        poetry install --with dev
        poetry add --group dev httpx pytest-asyncio pytest-cov

    - name: Run web API tests with 100% coverage requirement
      run: |
        poetry run pytest tests/test_web.py tests/test_web_e2e.py tests/test_web_coverage.py -v --tb=short \
          --cov=vpc_flow_investigator.web \
          --cov-report=xml \
          --cov-report=term-missing \
          --cov-fail-under=100

    - name: Upload API test coverage
      uses: codecov/codecov-action@v4
      if: matrix.python-version == '3.12'
      with:
        file: ./coverage.xml
        flags: web-api
        name: web-api-coverage

  integration-tests:
    name: Web Integration Tests
    runs-on: ubuntu-latest
    needs: api-tests

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Install dependencies
      run: |
        poetry install --with dev
        poetry add --group dev httpx pytest-asyncio

    - name: Start web server in background
      run: |
        poetry run python -c "
        import subprocess
        import time
        import requests
        from vpc_flow_investigator.web import app
        import uvicorn
        import threading
        
        def run_server():
            uvicorn.run(app, host='127.0.0.1', port=8000, log_level='error')
        
        server_thread = threading.Thread(target=run_server, daemon=True)
        server_thread.start()
        
        # Wait for server to start
        for i in range(30):
            try:
                response = requests.get('http://127.0.0.1:8000/api/test', timeout=1)
                if response.status_code == 200:
                    print('Server started successfully')
                    break
            except:
                time.sleep(1)
        else:
            raise Exception('Server failed to start')
        " &
        sleep 5

    - name: Test web server endpoints
      run: |
        # Test API endpoints
        curl -f http://127.0.0.1:8000/api/test || exit 1
        curl -f http://127.0.0.1:8000/api/profiles || exit 1
        
        # Test home page
        curl -f http://127.0.0.1:8000/ | grep -q "VPC Flow" || exit 1

    - name: Run integration tests
      run: |
        poetry run python -c "
        import requests
        import json
        
        # Test API endpoints
        base_url = 'http://127.0.0.1:8000'
        
        # Test /api/test
        response = requests.get(f'{base_url}/api/test')
        assert response.status_code == 200
        data = response.json()
        assert data['status'] == 'ok'
        print('✓ API test endpoint working')
        
        # Test /api/profiles
        response = requests.get(f'{base_url}/api/profiles')
        assert response.status_code == 200
        data = response.json()
        assert 'profiles' in data
        print('✓ Profiles endpoint working')
        
        # Test home page
        response = requests.get(f'{base_url}/')
        assert response.status_code == 200
        assert 'text/html' in response.headers.get('content-type', '')
        print('✓ Home page working')
        
        print('All integration tests passed!')
        "

  security-tests:
    name: Web Security Tests
    runs-on: ubuntu-latest
    needs: api-tests

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Install dependencies
      run: |
        poetry install --with dev
        poetry add --group dev httpx pytest-asyncio bandit safety

    - name: Run security scan on web module
      run: |
        poetry run bandit -r src/vpc_flow_investigator/web.py -f json -o bandit-report.json || true
        
    - name: Check for known vulnerabilities
      run: |
        poetry run safety check --json --output safety-report.json || true

    - name: Test for common web vulnerabilities
      run: |
        poetry run python -c "
        from fastapi.testclient import TestClient
        from vpc_flow_investigator.web import WebApplicationFactory
        
        app = WebApplicationFactory.create_app()
        client = TestClient(app)
        
        # Test for XSS protection
        response = client.get('/?test=<script>alert(1)</script>')
        assert '<script>' not in response.text
        print('✓ XSS protection working')
        
        # Test for SQL injection protection (basic)
        response = client.post('/api/analyze', data={
            'profile': \"'; DROP TABLE users; --\",
            'instance_id': 'i-1234567890abcdef0',
            'analysis': 'all'
        })
        # Should handle gracefully without SQL injection
        print('✓ SQL injection protection working')
        
        print('Security tests completed!')
        "

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  performance-tests:
    name: Web Performance Tests
    runs-on: ubuntu-latest
    needs: api-tests

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Install dependencies
      run: |
        poetry install --with dev
        poetry add --group dev httpx pytest-asyncio pytest-benchmark

    - name: Run performance tests
      run: |
        poetry run python -c "
        import time
        import concurrent.futures
        from fastapi.testclient import TestClient
        from vpc_flow_investigator.web import WebApplicationFactory
        
        app = WebApplicationFactory.create_app()
        client = TestClient(app)
        
        def test_endpoint():
            response = client.get('/api/test')
            return response.status_code == 200
        
        # Test concurrent requests
        start_time = time.time()
        with concurrent.futures.ThreadPoolExecutor(max_workers=10) as executor:
            futures = [executor.submit(test_endpoint) for _ in range(50)]
            results = [future.result() for future in concurrent.futures.as_completed(futures)]
        
        end_time = time.time()
        duration = end_time - start_time
        
        assert all(results), 'Some requests failed'
        assert duration < 10, f'Performance test took too long: {duration}s'
        
        print(f'✓ Handled 50 concurrent requests in {duration:.2f}s')
        print('Performance tests passed!')
        "